!function(t){"use strict";t.module("offline",[]).service("offlineHelper",["$http","$window","$q","$timeout",function(e,o,a,n){function s(){this.checkTime=5e3,this.processLocalXHR()}var c=this,r=o.localStorage;s.prototype.cacheList=JSON.parse(r.jqOffline||"[]"),s.prototype.timeoutId=null,s.prototype.networkIsConnect=!0,s.prototype.offConfig=function(){return{accessStatus:[500,404],message:"Network not connect, data has saved in localStorage.",key:"",checkTime:this.checkTime}},s.prototype.startCheck=function(t){var e=this;e.timeoutId=n(function(){e.processLocalXHR(),e.startCheck(t)},t.offConfig.checkTime)},s.prototype.stopCheck=function(){n.cancel(this.timeoutId)},s.prototype.processLocalXHR=function(){var e=this;e.cacheList.length&&t.forEach(e.cacheList,function(t){var o=JSON.parse(r[t]);e.main("ajax",o).then(function(t){e.checkIsAccessStatus(t.status,o)||(e.removeKeyFromList(o.offConfig.key),e.networkIsConnect=!0)})})},s.prototype.checkIsAccessStatus=function(t,e){return-1!==e.offConfig.accessStatus.indexOf(t)},s.prototype.removeKeyFromList=function(t){var e=this,o=e.cacheList.indexOf(t);return o>=0?(r.removeItem(t),e.cacheList.splice(o,1),r.cacheList=JSON.stringify(e.cacheList),!0):!1},s.prototype.saveDataInLocal=function(t){var e=this;t.offConfig.key=t.offConfig.key?t.offConfig.key:"offline_"+(new Date).getTime()+Math.floor(1e4*Math.random()),r[t.offConfig.key]=JSON.stringify(t),-1===e.cacheList.indexOf(t.offConfig.key)&&e.cacheList.push(t.offConfig.key),r.jqOffline=JSON.stringify(this.cacheList),e.timeoutId||e.startCheck(t)},s.prototype.post=function(t,e,o,a){return this.ajaxXHRGateway.call(this,e,o,a,"post")},s.prototype.get=function(t,e,o,a){return this.ajaxXHRGateway.call(this,e,o,a,"get")},s.prototype.put=function(t,e,o,a){return this.ajaxXHRGateway.call(this,e,o,a,"put")},s.prototype.delete=function(t,e,o,a){return this.ajaxXHRGateway.call(this,e,o,a,"delete")},s.prototype.ajaxXHRGateway=function(e,o,a,n){return t.isFunction(o)&&(n=n||a,a=o,o=void 0),this.ajax({url:e,type:n,data:o,success:a})},s.prototype.ajax=function(o,n){var s=this,c=a.defer();return"object"==typeof o&&(n=o,o=void 0),n=t.extend({offConfig:s.offConfig()},n),n.method=n.method||n.type,e(n).success(function(t,e){s.checkIsAccessStatus(e,n)?(n.offConfig.status=e,s.saveDataInLocal(n),c.resolve(n.offConfig)):c.resolve.apply(s,arguments)}).error(function(t,e){s.checkIsAccessStatus(e,n)?(n.offConfig.status=e,s.saveDataInLocal(n),c.resolve(n.offConfig)):c.reject.apply(s,arguments)}),c.promise},s.prototype.main=function(t){var e=this;switch(t){case"isConnect":return e.networkIsConnect;case"start":e.startCheck();break;case"stop":e.stopCheck();break;case"setCheckTime":var o=parseInt(arguments[1]);return o&&o>0&&(e.checkTime=o),e;case"get":return e.get.apply(e,arguments);case"post":return e.post.apply(e,arguments);case"put":return e.put.apply(e,arguments);case"delete":return e.delete.apply(e,arguments);case"ajax":var a;switch(arguments.length){case 2:return a=arguments[1],e.ajax.call(e,a);case 3:return a=arguments[2],a.url=arguments[1],e.ajax.call(e,a)}}};var i=new s;return c.offline=function(){return i.main.apply(i,arguments)},c}])}(angular);