!function(t){"use strict";t.module("offline",[]).service("offlineHelper",["$http","$window","$q","$timeout",function(e,o,n,a){function i(){this.checkTime=5e3,this.processLocalXHR()}var r=this,c=o.localStorage;i.prototype.cacheList=JSON.parse(c.jqOffline||"[]"),i.prototype.timeoutId=null,i.prototype.networkIsConnect=!0,i.prototype.offConfig=function(){return{message:"Network not connect, data has saved in localStorage.",key:"",checkTime:this.checkTime}},i.prototype.startCheck=function(t){var e=this;e.timeoutId=a(function(){e.processLocalXHR(),e.startCheck(t)},t.offConfig.checkTime)},i.prototype.stopCheck=function(){a.cancel(this.timeoutId)},i.prototype.processLocalXHR=function(){var e=this;e.cacheList.length&&t.forEach(e.cacheList,function(t){var o=JSON.parse(c[t]);e.main("ajax",o).then(function(t){t.isOffline||(e.removeKeyFromList(o.offConfig.key),e.networkIsConnect=!0)})})},i.prototype.removeKeyFromList=function(t){var e=this,o=e.cacheList.indexOf(t);return o>=0?(c.removeItem(t),e.cacheList.splice(o,1),c.jqOffline=JSON.stringify(e.cacheList),!0):!1},i.prototype.saveDataInLocal=function(t){var e=this;t.offConfig.key=t.offConfig.key?t.offConfig.key:"offline_"+(new Date).getTime()+Math.floor(1e4*Math.random()),c[t.offConfig.key]=JSON.stringify(t),-1===e.cacheList.indexOf(t.offConfig.key)&&e.cacheList.push(t.offConfig.key),c.jqOffline=JSON.stringify(this.cacheList),e.timeoutId||e.startCheck(t)},i.prototype.post=function(t,e,o,n){return this.ajaxXHRGateway.call(this,e,o,n,"post")},i.prototype.get=function(t,e,o,n){return this.ajaxXHRGateway.call(this,e,o,n,"get")},i.prototype.put=function(t,e,o,n){return this.ajaxXHRGateway.call(this,e,o,n,"put")},i.prototype.delete=function(t,e,o,n){return this.ajaxXHRGateway.call(this,e,o,n,"delete")},i.prototype.ajaxXHRGateway=function(e,o,n,a){return t.isFunction(o)&&(a=a||n,n=o,o=void 0),this.ajax({url:e,type:a,data:o,success:n})},i.prototype.ajax=function(o,a){var i=this,r=n.defer();return"object"==typeof o&&(a=o,o=void 0),a.offConfig=t.extend(i.offConfig(),a.offConfig||{}),a.method=a.method||a.type,e(a).success(function(){r.resolve.apply(i,arguments)}).error(function(t,e){0===e?(a.offConfig.status=e,i.saveDataInLocal(a),i.networkIsConnect=!1,a.offConfig.isOffline=!0,r.resolve(a.offConfig,e)):r.reject.apply(i,arguments)}),r.promise},i.prototype.main=function(t,e,o){var n=this;switch(t){case"isConnect":return n.networkIsConnect;case"start":n.startCheck();break;case"stop":n.stopCheck();break;case"setCheckTime":var a=parseInt(e);return a&&a>0&&(n.checkTime=a),n;case"get":return n.get.apply(n,arguments);case"post":return n.post.apply(n,arguments);case"put":return n.put.apply(n,arguments);case"delete":return n.delete.apply(n,arguments);case"ajax":return"object"==typeof e?(o=e,e=void 0,n.ajax.call(n,o)):(o.url=e,n.ajax.call(n,o))}};var s=new i;return r.offline=function(){return s.main.apply(s,arguments)},r}])}(angular);